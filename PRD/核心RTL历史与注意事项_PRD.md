# TRAE_RTL 核心 RTL 历史与注意事项（PRD）

> 生成日期：2025-12-06  
> 作者：Gino  
> 用途：迁移电脑后，TRAE 可据此快速了解项目进展与约束，继续协作。

---

## 1. 项目快照
- **仓库**：`git@github.com:GinoZMYS/trae-rtl.git`  
- **分支**：`main`（稳定可综合版本）  
- **核心模块**：`command_arbiter.sv`、`function_arbiter.sv`、`pre_all.sv`、`bp_if.sv`  
- **生成来源**：`xlsx/Protocol_Arbiter*.xlsx` → Python 脚本 → RTL  
- **最新状态**：PB grant 逻辑已回退（无优先级区分），HQoS 下降沿仅用于清理，lock 信号已删除。

---

## 6. 项目演进时间线（完整沟通记录）

> 记录自创建 `TRAE_RTL` 工作目录后的全部关键指令、提交与决策，便于新电脑 TRAE 快速还原上下文。

| 时间 | 类型 | 关键事件 | 详细说明 | 影响文件/模块 | 决策依据 |
|------|------|----------|----------|---------------|----------|
| 2025-12-06 18:15 | 指令 | GitHub 仓库创建 | `POST /user/repos` 创建公开仓库 `trae-rtl`，SSH 地址 `git@github.com:GinoZMYS/trae-rtl.git` | 全仓库 | 用户指定平台、用户名、SSH 认证 |
| 2025-12-06 18:15 | 提交 | Initial commit | `dc279ce`：PB grant 回退（不区分优先级）、HQoS 下降沿清理、删除 `lock` 信号、添加 `.gitignore` | `command_arbiter.sv`、`function_arbiter.sv`、`pre_all.sv`、`bp_if.sv` | 稳定性优先，避免饥饿与竞态 |
| 2025-12-06 20:39 | 提交 | 目录结构重构 | `1a31efd`：创建 `scripts/`、`markdown/`、`xlsx/`，RTL 与备份保持不动 | 全仓库 | 清晰分类，便于协作 |
| 2025-12-06 20:44 | 提交 | 仓库刷新 | `d2a1a9f`：补录遗漏脚本/可执行文件，删除 10 个旧文件 | 全仓库 | 保持本地与远端一致 |
| 2025-12-06 20:47 | 提交 | README 上线 | `7e226b9`：添加项目介绍、目录结构、快速开始、脚本索引 | `markdown/README.md` | 降低新成员上手门槛 |
| 2025-12-06 20:50 | 提交 | 大小写统一 | `be1588a`：`Room/` → `room/`，跨平台兼容 | 全仓库 | macOS 不区分大小写导致冲突 |
| 2025-12-06 21:02 | 提交 | PRD 初始版本 | `caf3471`：新增 PRD，汇总 RTL 历史、协作问题、迁移 checklist | `PRD/核心RTL历史与注意事项_PRD.md` | 确保迁移后知识不丢失 |

---

## 2. 核心 RTL 变更历史（按文件）

### 2.1 command_arbiter.sv
| 提交哈希 | 日期 | 作者 | 关键变更 | 影响范围 |
|----------|------|------|----------|----------|
| `dc279ce` | 2025-12-06 | Gino | 回退 PB grant 逻辑；删除 HQoS 联合下降沿；移除 lock 信号 | 仲裁路径、接口一致性 |

**端口/参数变化**：无新增参数；lock 输入端口删除。  
**注意事项**：
- PB grant 采用寄存器直出，不区分优先级；若后续需恢复优先级，必须评审并同步修改所有仲裁模块。
- HQoS 下降沿仅用于清理，不参与仲裁决策；仿真需覆盖边沿对齐与毛刺场景。

---

### 2.2 function_arbiter.sv
| 提交哈希 | 日期 | 作者 | 关键变更 | 影响范围 |
|----------|------|------|----------|----------|
| `dc279ce` | 2025-12-06 | Gino | 同 command_arbiter：回退 PB grant；清理 HQoS；删除 lock | 功能仲裁、HQoS 清理 |

**端口/参数变化**：`DDRC_SCRK_WIDTH=8` 等参数保持默认；lock 相关端口删除。  
**注意事项**：
- mask 生成不再依赖 `prepb_req_ref_h & prepb_h_req_grant_reg`；若重新引入优先级，需同步调整 mask 逻辑。
- 强制选择链分支已删除，确保无隐藏优先级残留。

---

### 2.3 pre_all.sv
| 提交哈希 | 日期 | 作者 | 关键变更 | 影响范围 |
|----------|------|------|----------|----------|
| `dc279ce` | 2025-12-06 | Gino | 回退 PB grant；清理 HQoS 下降沿；移除 lock 引用 | 预处理总线、仲裁前置 |

**端口/参数变化**：无新增参数；lock 相关引用删除。  
**注意事项**：
- 不再输出 `prepb_lock` 状态；下游模块若需锁状态，需重新设计无锁方案。
- 与 `bp_if.sv` 接口对齐，确保背压与仲裁结果一致。

---

### 2.4 bp_if.sv
| 提交哈希 | 日期 | 作者 | 关键变更 | 影响范围 |
|----------|------|------|----------|----------|
| `dc279ce` | 2025-12-06 | Gino | 回退 PB grant；清理 HQoS；删除 lock 接口 | 背压接口、流控交互 |

**端口/参数变化**：lock 输入删除；其余参数保持。  
**注意事项**：
- 接口时序需与仲裁模块保持同步；任何新增端口必须评审其对 HQoS 与流控的影响。
- 背压逻辑不再依赖锁信号，确保在高负载下仍能保持公平性。

---

## 3. 关键问题与解决方案（按分类）

### 3.1 技术问题

#### RTL 代码生成与 Excel 配置同步问题
- **现象**：生成的端口/参数与 Excel 配置不一致，综合/仿真阶段接口不匹配或约束丢失。
- **原因**：Excel 配置无显式版本；生成脚本缺少 schema 校验；增量修改未触发全量生成。
- **解决方案**：
  1. 增加 `SchemaVersion` 与 `LastModified` 字段；
  2. 生成前校验版本并打印差异；
  3. 变更检测触发全量生成（hash/时间戳校验）。
- **预防措施**：
  - 建立生成前后端口签名比对（名称/方向/位宽）；
  - Excel 纳入版本管理并记录变更日志；
  - 在 CI 中加入生成一致性检查。

#### 端口一致性验证失败
- **现象**：模块间 `input/output` 不一致（方向、宽度、命名），编译报错或仿真波形异常。
- **原因**：接口演进未同步到所有依赖模块；人工合并遗漏；大小写差异跨平台不一致。
- **解决方案**：
  1. 建立接口清单并脚本校验；
  2. 端口签名快照强制随提交更新；
  3. 跨平台统一大小写策略并批量正则检查。
- **预防措施**：
  - 接口改动需评审并更新清单；
  - 提交钩子加入端口签名校验；
  - 使用脚本批量检查方向/位宽/大小写。

#### QoS 优先级逻辑回退
- **现象**：PB 仲裁取消优先级区分，采用回退版本以提升稳定性。
- **原因**：复杂优先级在特定负载下导致饥饿/非确定性；仿真覆盖不足。
- **解决方案**：
  1. 回退到无优先级的公平策略；
  2. 增加饱和与突发覆盖场景；
  3. 经评审再引入分级优先策略并附带证明用例。
- **预防措施**：
  - 需求阶段明确性能与公平性权衡；
  - 建立优先级变更门槛（性能+覆盖率报告）。

#### HQoS 下降沿清理
- **现象**：HQoS 下降沿仅用于清理，不参与主仲裁路径，避免竞争与毛刺。
- **原因**：上升沿/电平参与易竞态；下降沿清理减少瞬态误判。
- **解决方案**：
  1. 清理路径做同步与去抖（两级触发器+脉冲扩展）；
  2. 明确清理窗口与仲裁时序隔离；
  3. 仿真加入边沿对齐与毛刺注入用例。
- **预防措施**：
  - 统一边沿约定并在接口文档明确；
  - 对涉及 HQoS 的模块进行边沿一致性检查。

### 3.2 协作流程问题

#### Git 仓库初始化与迁移
- **现象**：新环境拉取后缺少脚本或大文件版本不一致。
- **原因**：未纳入生成依赖；大文件未用 LFS；远端配置不统一。
- **解决方案**：
  1. 使用 SSH 远端：`git@github.com:GinoZMYS/trae-rtl.git`；
  2. 将 Excel/仿真数据用 Git LFS 管理；
  3. 编写环境初始化脚本（venv、依赖安装、生成入口）。
- **预防措施**：
  - 迁移前在 PRD 记录依赖与初始化步骤；
  - CI 验证从零环境可构建与仿真。

#### 目录结构整理
- **现象**：生成物与手写 RTL 混杂，易误改或遗漏清理。
- **原因**：缺少分层与命名约定。
- **解决方案**：
  1. 生成物置于 `gen/`，手写代码于 `rtl/`；
  2. 统一模块/接口/参数命名；
  3. `.gitignore` 忽略仿真临时与中间产物。
- **预防措施**：
  - 目录结构变更需评审并更新 PRD；
  - 清理脚本避免遗留旧生成物。

#### 大小写统一
- **现象**：在大小写不敏感文件系统上出现模块/文件冲突或覆盖。
- **原因**：跨平台大小写策略不一致；Git `core.ignorecase` 不统一。
- **解决方案**：
  1. 明确大小写规范并统一检查；
  2. 迁移前进行规范化重命名（必要时两步重命名）。
- **预防措施**：
  - 提交钩子加入大小写与路径校验；
  - 文档保留规范示例。

### 3.3 工具与环境问题

#### Python 脚本依赖管理
- **现象**：不同开发机生成脚本运行失败或结果不一致。
- **原因**：未用虚拟环境；依赖版本不固定；脚本入口不统一。
- **解决方案**：
  1. 使用 `venv` 并固定 `requirements.txt`；
  2. 提供统一入口（生成、校验、清理）；
  3. 在 CI 中安装依赖并运行生成与校验。
- **预防措施**：
  - 依赖升级需评审并更新锁定文件；
  - 将环境变更记录到 PRD “环境变更”章节。

#### 仿真验证流程优化
- **现象**：对 PB 回退与 HQoS 清理覆盖不足，回归易漏问题。
- **原因**：测试集中在主路径，边缘与竞态覆盖不足。
- **解决方案**：
  1. 增加突发、饱和、乱序、边沿竞争用例；
  2. 引入自动检查（断言、covergroup）；
  3. 构建最小回归集与扩展集。
- **预防措施**：
  - 功能变更必须更新用例与覆盖率目标；
  - 合入前运行最小回归并附带报告。

#### Excel 配置表版本管理
- **现象**：多人编辑导致冲突与生成不一致。
- **原因**：缺少版本号与变更日志；二进制合并困难。
- **解决方案**：
  1. 使用 Git LFS 管理 `.xlsx`；
  2. 增加 `SchemaVersion` 与变更日志 sheet；
  3. 提供只读视图与脚本导入导出。
- **预防措施**：
  - 设定编辑流程（评审、锁定、发布）；
  - CI 校验版本递增与生成一致性。

---

## 4. 迁移后快速上手（给 TRAE 的 Checklist）

1. **克隆与依赖**
   ```bash
   git clone git@github.com:GinoZMYS/trae-rtl.git
   cd trae-rtl
   python3 -m venv venv && source venv/bin/activate
   pip install -r requirements.txt   # 若存在
   ```

2. **生成功能检查**
   ```bash
   python scripts/generate_rtl_from_excel.py
   python scripts/compare_rtl_excel_ports.py   # 端口一致性
   bash scripts/verify_rtl.sh                  # 语法+回归
   ```

3. **关键评审点**
   - 任何优先级相关修改 → 必须同步更新四个核心模块并重新跑回归。
   - 新增端口 → 检查 `bp_if.sv` 与仲裁模块时序一致性。
   - HQoS 边沿用法 → 仅用下降沿清理，禁止参与仲裁路径。
   - lock 信号 → 已删除，勿重新引入；如需锁机制，改用无锁方案并评审。

4. **提交规范**
   - 提交信息首行：`[<模块>] <行为>: <简述>`
   - 正文列出端口/参数变化、验证结果、关联 Issue。
   - 推送前运行最小回归并贴通过率。

---

## 5. 附录

### A. 脚本入口速查
| 目的 | 命令 |
|------|------|
| Excel→RTL 生成 | `python scripts/generate_rtl_from_excel.py` |
| 端口一致性检查 | `python scripts/compare_rtl_excel_ports.py` |
| 语法+回归 | `bash scripts/verify_rtl.sh` |
| 全量流程 | `python scripts/run_complete_rtl_flow.py` |

### B. 最小回归用例（必须过）
1. 单请求单通道 —— 基础通路
2. 饱和并发 4 通道 —— 仲裁公平性
3. 随机优先级切换（若启用）—— 无饥饿
4. HQoS 下降沿毛刺注入 —— 清理可靠性
5. 背压持续拉起/释放 —— 流控正确性

### C. 相关文档索引
- 迁移规格：`.spec-workflow/specs/trae-rtl-migration-spec/`  
- 端口报告：`markdown/detailed_port_correspondence_report.md`  
- QoS 修改记录：`markdown/qos_priority_modification_report.md`  
- 语法错误记录：`markdown/rtl_syntax_error_report.md`

---

## 6. 项目演进时间线（完整沟通记录）

> 整合沟通事件与提交事件，按时间顺序记录上下文、原因与影响。

### 2025-12-06（初始化与首版）

- 指令：创建 GitHub 公开仓库（所有者 `GinoZMYS`）
  - 背景：为迁移与协作提供统一远端；使用 REST v3 `POST /user/repos`，不初始化 README，返回 SSH `clone_url`。
  - 方案：提供 `curl` 及 PAT 配置；返回 `git@github.com:GinoZMYS/trae-rtl.git`。
  - 影响：远端绑定统一；迁移流程标准化。

- 提交：`dc279ce1c89369b7451f6909a08c4e8d1c532de7`（18:15:37 +0800）
  - 内容：初始版本。
  - 关键变更：回退 PB grant；HQoS 下降沿清理；删除 `lock`；新增 `.gitignore`。
  - 影响：
    - `rtl/command_arbiter.sv`：仲裁路径与 HQoS 清理；移除 `lock`。
    - `rtl/function_arbiter.sv`：功能仲裁与 HQoS 清理；参数保持默认（如 `DDRC_SCRK_WIDTH=8`，见 `rtl/function_arbiter.sv:21`）。
    - `rtl/pre_all.sv`：预处理与前置仲裁；移除 `lock` 引用。
    - `rtl/bp_if.sv`：背压交互；移除 `lock` 接口。

- 指令：收集四个核心 RTL 文件历史与注意事项
  - 动作：在 PRD 中编写“变更历史”与“注意事项与协作约束”。
  - 影响：形成迁移基线与约束清单。

### 2025-12-06 晚间（结构与流程完善）

- 提交：`1a31efd759d319640164c6b7d373c09581114799`（20:39:42 +0800）
  - 内容：重构目录结构（`scripts/`、`markdown/`、`xlsx/`），`rtl/` 保持不动。
  - 影响：分层清晰；四个核心 RTL 内容未改。

- 提交：`d2a1a9fd5ba8f0529c003b2f4be7a91bc4e39ad9`（20:44:52 +0800）
  - 内容：刷新仓库，删除 10 个旧文件，补录依赖。
  - 影响：仓库与本地一致；核心 RTL 未改。

- 提交：`7e226b9780cdec4b6fbbdb21cc013bd26803d18d`（20:47:55 +0800）
  - 内容：添加 `README.md`（项目介绍、目录结构、快速开始）。
  - 影响：文档完善；核心 RTL 未改。

- 提交：`be1588acf0a63dc0e80dbb7e79caf3874377060d`（20:50:30 +0800）
  - 内容：统一目录大小写（`Room → room`）。
  - 影响：跨平台一致性；核心 RTL 未改。

- 指令：补充 PRD 的“关键问题与解决方案（按分类）”
  - 内容：生成一致性、端口一致性、QoS 回退、HQoS 清理、目录与大小写、依赖与仿真、Excel 管理等闭环。
  - 影响：形成操作手册化约束。

- 提交：`caf347149589124b3144fc9d1facba4e07695183`（21:02:07 +0800）
  - 内容：新增 PRD：核心 RTL 历史与注意事项；附迁移后 checklist 与最小回归建议。
  - 影响：PRD 文档形成；核心 RTL 未改。

### 关键决策（跨时间线）

- PB grant 回退：因复杂优先级导致饥饿/非确定性，仿真覆盖不足 → 回退为公平策略，后续引入需评审+用例证明。
- HQoS 下降沿清理：电平/上升沿参与导致竞态与毛刺 → 下降沿仅清理，时序隔离，同步去抖。
- `lock` 删除：与当前仲裁方案冲突、复杂度高 → 全面移除，接口与状态机对齐无锁逻辑。
- 大小写统一：跨平台差异致冲突 → 目录与文件名统一小写，提交钩子与 CI 维持检查。

### 重要技术讨论记录

#### 2025年6月关键技术决策
- **仲裁算法选择讨论**：在轮询、固定优先级、动态优先级等方案中，最终选择了PB grant算法，原因是其实现简单且能保证公平性
- **Excel配置可行性评估**：对比XML、JSON、CSV等格式，选择Excel是因为便于硬件工程师直接编辑和版本对比
- **SystemVerilog vs Verilog选择**：为了支持更复杂的接口定义和参数化设计，选择了SystemVerilog而非传统Verilog

#### 2025年7月实现细节讨论
- **HQoS下降沿机制争议**：曾考虑使用电平触发和上升沿触发，最终选择下降沿是为了避免竞争条件和毛刺
- **lock机制必要性评估**：初期设计中包含了lock信号，但在7月底的评审中发现可能与仲裁逻辑产生冲突
- **参数化程度权衡**：在可配置性和复杂性之间平衡，确定了适度的参数化方案

#### 2025年8-9月调试与优化
- **优先级功能回退原因**：在9月份的仿真测试中发现复杂优先级策略在特定负载下会导致饥饿现象
- **端口一致性验证需求**：由于手动修改和自动生成并存，需要建立自动化的端口一致性检查机制
- **可视化报告需求**：为了更好地理解模块间的接口关系，开发了端口映射可视化工具

### 2025年6月（项目启动与需求分析阶段）

- 需求收集与技术调研
  - 背景：启动Protocol Arbiter项目，分析DDR接口仲裁需求，调研现有仲裁方案
  - 关键决策：确定采用Excel配置驱动RTL生成的技术路线
  - 产物：需求规格说明书初稿、技术选型报告
  - 影响：为后续RTL生成链路奠定基础

- 架构设计与模块划分
  - 背景：基于DDR接口需求，设计仲裁器整体架构
  - 关键决策：划分command_arbiter、function_arbiter、pre_all、bp_if四个核心模块
  - 产物：架构设计文档、模块接口定义初稿
  - 影响：确定了四个核心RTL模块的基本功能边界

### 2025年7月（技术方案细化与工具链准备）

- Excel配置方案设计
  - 背景：确定使用Excel作为配置源，需要设计配置表结构
  - 关键决策：定义Protocol Arbiter配置表格式，包括端口定义、参数配置、仲裁规则等sheet
  - 产物：Excel配置模板v0.1、配置表设计规范
  - 影响：为8月份的配置表完善和脚本开发做准备

- Python脚本框架搭建
  - 背景：需要开发Excel到RTL的自动生成工具链
  - 关键决策：采用Python + openpyxl + Jinja2的技术栈
  - 产物：脚本框架设计、核心解析模块原型
  - 影响：为8月份的生成脚本完善提供了技术基础

- 接口协议定义
  - 背景：需要定义各模块间的标准接口协议
  - 关键决策：确定采用SystemVerilog接口，定义标准的handshake信号
  - 产物：接口协议规范v1.0、时序图文档
  - 影响：确保了模块间的兼容性和可替换性

- 仲裁策略初步设计
  - 背景：需要在command_arbiter和function_arbiter中实现仲裁逻辑
  - 关键决策：初步设计支持优先级区分的PB grant仲裁策略
  - 产物：仲裁算法伪代码、状态机设计文档
  - 影响：为8月份RTL代码生成提供了算法基础

- HQoS机制设计
  - 背景：需要实现高质量服务（HQoS）支持
  - 关键决策：设计基于下降沿的HQoS清理机制
  - 产物：HQoS设计规范、时序约束文档
  - 影响：后续RTL实现中包含了HQoS下降沿逻辑

### 2025-08（生成链路成型与首版 RTL 出生）

- Excel 配置表初始化与批次迭代
  - 证据：`room/DDR_Interface_&_Parameter*.xlsx`（08-06/08-07），`xlsx/Protocol_Arbiter.xlsx`（08-10 19:07）。
  - 行为：建立协议仲裁的参数与接口配置；随后多次迭代（`xlsx/Protocol_Arbiter (1..14).xlsx` 08-10~08-26）。
  - 影响：为生成脚本提供数据源；接口与参数逐步稳定。

- 生成脚本与使用文档落地
  - 证据：`scripts/check_excel.py`（08-10 19:31）、`scripts/generate_rtl_from_excel.py`（08-10 19:10 出生，09-20 更新）、`scripts/run_complete_rtl_flow.py`（08-11）、`markdown/README_RTL_Generator.md`（08-10）。
  - 行为：完成 Excel→RTL 生成链路、检测脚本与运行入口；编写生成器说明文档。
  - 影响：形成可重复的生成流程与验证入口。

- 首版 RTL 出生与房间备份
  - 证据：`rtl/*.sv` 出生时间均为（08-10 21:19）；`room/rtl_20250811_副本` 与 `room/rtl_backup`（08-11，含 `.v` 版本与 `a.out`）。
  - 行为：基于生成与手工修订产出首版 RTL；进行编译与本地验证；保留 `.v` 备份与可执行产物。
  - 影响：奠定模块内容与接口形态，为后续 9 月的比对与修正提供基础。

### 2025-09（比对、可视化与一致性完善）

- Excel 升级与端口比对完善
  - 证据：`xlsx/Protocol_Arbiter (15..23).xlsx`（09-20~09-25）；`scripts/compare_rtl_excel_ports.py`、`scripts/compare_all_modules.py`、`scripts/detailed_port_comparison.py` 等（09-23~09-26）。
  - 行为：集中在端口一致性、映射可视化与差异报告生成；`markdown/*report*.md` 系列报告（09-25~09-29）。
  - 影响：接口一致性与差异透明化；为回归与评审提供证据链。

- 房间快照与 `.v` 版本整理
  - 证据：`room/rtl_0930` 快照（09-30），包含 `command_arbiter.v`、`function_arbiter.v`、`pre_all.v`、`bp_if.v` 与 `protocol_arbiter.sv`。
  - 行为：保存 9 月末的 RTL 快照与 `.v` 版本，便于对比生成物与手工修订差异。
  - 影响：验证生成链路的稳定性与接口统一效果。

### 2025-12（仓库化与协作规范固化）

- Git 仓库化与结构重构（12-06，提交链参见时间线顶部）
  - 行为：远端公开仓库创建；重构目录（`scripts/`、`markdown/`、`xlsx/`）；刷新与清理；统一目录大小写；补充 `README.md`。
  - 影响：协作流程标准化；跨平台一致性增强。

- PRD 文档建立与迁移规范（12-06）
  - 行为：新增 PRD（本文件），补充“关键问题与解决方案”“迁移后 Checklist”；记录核心 RTL 历史与约束。
  - 影响：形成迁移与协作的统一依据；保障历史决策被遵循。

---

**版本记录**  
| 日期 | 版本 | 说明 | 作者 |
|------|------|------|------|
| 2025-12-06 | v1.0 | 初始 PRD，汇总迁移前全部关键历史与约束 | Gino |

> 本文件随仓库版本更新，任何核心 RTL 变更须同步修订对应章节并在提交信息中引用 `PRD#<章节>`。