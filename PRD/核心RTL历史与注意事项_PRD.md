# TRAE_RTL 核心 RTL 历史与注意事项（PRD）

> 生成日期：2025-12-06  
> 作者：Gino  
> 用途：迁移电脑后，TRAE 可据此快速了解项目进展与约束，继续协作。

---

## 1. 项目快照
- **仓库**：`git@github.com:GinoZMYS/trae-rtl.git`  
- **分支**：`main`（稳定可综合版本）  
- **核心模块**：`command_arbiter.sv`、`function_arbiter.sv`、`pre_all.sv`、`bp_if.sv`  
- **生成来源**：`xlsx/Protocol_Arbiter*.xlsx` → Python 脚本 → RTL  
- **最新状态**：PB grant 逻辑已回退（无优先级区分），HQoS 下降沿仅用于清理，lock 信号已删除。

---

## 2. 核心 RTL 变更历史（按文件）

### 2.1 command_arbiter.sv
| 提交哈希 | 日期 | 作者 | 关键变更 | 影响范围 |
|----------|------|------|----------|----------|
| `dc279ce` | 2025-12-06 | Gino | 回退 PB grant 逻辑；删除 HQoS 联合下降沿；移除 lock 信号 | 仲裁路径、接口一致性 |

**端口/参数变化**：无新增参数；lock 输入端口删除。  
**注意事项**：
- PB grant 采用寄存器直出，不区分优先级；若后续需恢复优先级，必须评审并同步修改所有仲裁模块。
- HQoS 下降沿仅用于清理，不参与仲裁决策；仿真需覆盖边沿对齐与毛刺场景。

---

### 2.2 function_arbiter.sv
| 提交哈希 | 日期 | 作者 | 关键变更 | 影响范围 |
|----------|------|------|----------|----------|
| `dc279ce` | 2025-12-06 | Gino | 同 command_arbiter：回退 PB grant；清理 HQoS；删除 lock | 功能仲裁、HQoS 清理 |

**端口/参数变化**：`DDRC_SCRK_WIDTH=8` 等参数保持默认；lock 相关端口删除。  
**注意事项**：
- mask 生成不再依赖 `prepb_req_ref_h & prepb_h_req_grant_reg`；若重新引入优先级，需同步调整 mask 逻辑。
- 强制选择链分支已删除，确保无隐藏优先级残留。

---

### 2.3 pre_all.sv
| 提交哈希 | 日期 | 作者 | 关键变更 | 影响范围 |
|----------|------|------|----------|----------|
| `dc279ce` | 2025-12-06 | Gino | 回退 PB grant；清理 HQoS 下降沿；移除 lock 引用 | 预处理总线、仲裁前置 |

**端口/参数变化**：无新增参数；lock 相关引用删除。  
**注意事项**：
- 不再输出 `prepb_lock` 状态；下游模块若需锁状态，需重新设计无锁方案。
- 与 `bp_if.sv` 接口对齐，确保背压与仲裁结果一致。

---

### 2.4 bp_if.sv
| 提交哈希 | 日期 | 作者 | 关键变更 | 影响范围 |
|----------|------|------|----------|----------|
| `dc279ce` | 2025-12-06 | Gino | 回退 PB grant；清理 HQoS；删除 lock 接口 | 背压接口、流控交互 |

**端口/参数变化**：lock 输入删除；其余参数保持。  
**注意事项**：
- 接口时序需与仲裁模块保持同步；任何新增端口必须评审其对 HQoS 与流控的影响。
- 背压逻辑不再依赖锁信号，确保在高负载下仍能保持公平性。

---

## 3. 关键问题与解决方案（按分类）

### 3.1 技术问题

#### RTL 代码生成与 Excel 配置同步问题
- **现象**：生成的端口/参数与 Excel 配置不一致，综合/仿真阶段接口不匹配或约束丢失。
- **原因**：Excel 配置无显式版本；生成脚本缺少 schema 校验；增量修改未触发全量生成。
- **解决方案**：
  1. 增加 `SchemaVersion` 与 `LastModified` 字段；
  2. 生成前校验版本并打印差异；
  3. 变更检测触发全量生成（hash/时间戳校验）。
- **预防措施**：
  - 建立生成前后端口签名比对（名称/方向/位宽）；
  - Excel 纳入版本管理并记录变更日志；
  - 在 CI 中加入生成一致性检查。

#### 端口一致性验证失败
- **现象**：模块间 `input/output` 不一致（方向、宽度、命名），编译报错或仿真波形异常。
- **原因**：接口演进未同步到所有依赖模块；人工合并遗漏；大小写差异跨平台不一致。
- **解决方案**：
  1. 建立接口清单并脚本校验；
  2. 端口签名快照强制随提交更新；
  3. 跨平台统一大小写策略并批量正则检查。
- **预防措施**：
  - 接口改动需评审并更新清单；
  - 提交钩子加入端口签名校验；
  - 使用脚本批量检查方向/位宽/大小写。

#### QoS 优先级逻辑回退
- **现象**：PB 仲裁取消优先级区分，采用回退版本以提升稳定性。
- **原因**：复杂优先级在特定负载下导致饥饿/非确定性；仿真覆盖不足。
- **解决方案**：
  1. 回退到无优先级的公平策略；
  2. 增加饱和与突发覆盖场景；
  3. 经评审再引入分级优先策略并附带证明用例。
- **预防措施**：
  - 需求阶段明确性能与公平性权衡；
  - 建立优先级变更门槛（性能+覆盖率报告）。

#### HQoS 下降沿清理
- **现象**：HQoS 下降沿仅用于清理，不参与主仲裁路径，避免竞争与毛刺。
- **原因**：上升沿/电平参与易竞态；下降沿清理减少瞬态误判。
- **解决方案**：
  1. 清理路径做同步与去抖（两级触发器+脉冲扩展）；
  2. 明确清理窗口与仲裁时序隔离；
  3. 仿真加入边沿对齐与毛刺注入用例。
- **预防措施**：
  - 统一边沿约定并在接口文档明确；
  - 对涉及 HQoS 的模块进行边沿一致性检查。

### 3.2 协作流程问题

#### Git 仓库初始化与迁移
- **现象**：新环境拉取后缺少脚本或大文件版本不一致。
- **原因**：未纳入生成依赖；大文件未用 LFS；远端配置不统一。
- **解决方案**：
  1. 使用 SSH 远端：`git@github.com:GinoZMYS/trae-rtl.git`；
  2. 将 Excel/仿真数据用 Git LFS 管理；
  3. 编写环境初始化脚本（venv、依赖安装、生成入口）。
- **预防措施**：
  - 迁移前在 PRD 记录依赖与初始化步骤；
  - CI 验证从零环境可构建与仿真。

#### 目录结构整理
- **现象**：生成物与手写 RTL 混杂，易误改或遗漏清理。
- **原因**：缺少分层与命名约定。
- **解决方案**：
  1. 生成物置于 `gen/`，手写代码于 `rtl/`；
  2. 统一模块/接口/参数命名；
  3. `.gitignore` 忽略仿真临时与中间产物。
- **预防措施**：
  - 目录结构变更需评审并更新 PRD；
  - 清理脚本避免遗留旧生成物。

#### 大小写统一
- **现象**：在大小写不敏感文件系统上出现模块/文件冲突或覆盖。
- **原因**：跨平台大小写策略不一致；Git `core.ignorecase` 不统一。
- **解决方案**：
  1. 明确大小写规范并统一检查；
  2. 迁移前进行规范化重命名（必要时两步重命名）。
- **预防措施**：
  - 提交钩子加入大小写与路径校验；
  - 文档保留规范示例。

### 3.3 工具与环境问题

#### Python 脚本依赖管理
- **现象**：不同开发机生成脚本运行失败或结果不一致。
- **原因**：未用虚拟环境；依赖版本不固定；脚本入口不统一。
- **解决方案**：
  1. 使用 `venv` 并固定 `requirements.txt`；
  2. 提供统一入口（生成、校验、清理）；
  3. 在 CI 中安装依赖并运行生成与校验。
- **预防措施**：
  - 依赖升级需评审并更新锁定文件；
  - 将环境变更记录到 PRD “环境变更”章节。

#### 仿真验证流程优化
- **现象**：对 PB 回退与 HQoS 清理覆盖不足，回归易漏问题。
- **原因**：测试集中在主路径，边缘与竞态覆盖不足。
- **解决方案**：
  1. 增加突发、饱和、乱序、边沿竞争用例；
  2. 引入自动检查（断言、covergroup）；
  3. 构建最小回归集与扩展集。
- **预防措施**：
  - 功能变更必须更新用例与覆盖率目标；
  - 合入前运行最小回归并附带报告。

#### Excel 配置表版本管理
- **现象**：多人编辑导致冲突与生成不一致。
- **原因**：缺少版本号与变更日志；二进制合并困难。
- **解决方案**：
  1. 使用 Git LFS 管理 `.xlsx`；
  2. 增加 `SchemaVersion` 与变更日志 sheet；
  3. 提供只读视图与脚本导入导出。
- **预防措施**：
  - 设定编辑流程（评审、锁定、发布）；
  - CI 校验版本递增与生成一致性。

---

## 4. 迁移后快速上手（给 TRAE 的 Checklist）

1. **克隆与依赖**
   ```bash
   git clone git@github.com:GinoZMYS/trae-rtl.git
   cd trae-rtl
   python3 -m venv venv && source venv/bin/activate
   pip install -r requirements.txt   # 若存在
   ```

2. **生成功能检查**
   ```bash
   python scripts/generate_rtl_from_excel.py
   python scripts/compare_rtl_excel_ports.py   # 端口一致性
   bash scripts/verify_rtl.sh                  # 语法+回归
   ```

3. **关键评审点**
   - 任何优先级相关修改 → 必须同步更新四个核心模块并重新跑回归。
   - 新增端口 → 检查 `bp_if.sv` 与仲裁模块时序一致性。
   - HQoS 边沿用法 → 仅用下降沿清理，禁止参与仲裁路径。
   - lock 信号 → 已删除，勿重新引入；如需锁机制，改用无锁方案并评审。

4. **提交规范**
   - 提交信息首行：`[<模块>] <行为>: <简述>`
   - 正文列出端口/参数变化、验证结果、关联 Issue。
   - 推送前运行最小回归并贴通过率。

---

## 5. 附录

### A. 脚本入口速查
| 目的 | 命令 |
|------|------|
| Excel→RTL 生成 | `python scripts/generate_rtl_from_excel.py` |
| 端口一致性检查 | `python scripts/compare_rtl_excel_ports.py` |
| 语法+回归 | `bash scripts/verify_rtl.sh` |
| 全量流程 | `python scripts/run_complete_rtl_flow.py` |

### B. 最小回归用例（必须过）
1. 单请求单通道 —— 基础通路
2. 饱和并发 4 通道 —— 仲裁公平性
3. 随机优先级切换（若启用）—— 无饥饿
4. HQoS 下降沿毛刺注入 —— 清理可靠性
5. 背压持续拉起/释放 —— 流控正确性

### C. 相关文档索引
- 迁移规格：`.spec-workflow/specs/trae-rtl-migration-spec/`  
- 端口报告：`markdown/detailed_port_correspondence_report.md`  
- QoS 修改记录：`markdown/qos_priority_modification_report.md`  
- 语法错误记录：`markdown/rtl_syntax_error_report.md`

---

**版本记录**  
| 日期 | 版本 | 说明 | 作者 |
|------|------|------|------|
| 2025-12-06 | v1.0 | 初始 PRD，汇总迁移前全部关键历史与约束 | Gino |

> 本文件随仓库版本更新，任何核心 RTL 变更须同步修订对应章节并在提交信息中引用 `PRD#<章节>`。